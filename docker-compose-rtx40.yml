version: '3.8'

services:
  deepseek-ocr-rtx40:
    build:
      context: .
      dockerfile: Dockerfile.rtx40
    image: deepseek-ocr:rtx40
    container_name: deepseek-ocr-service-rtx40
    
    # GPU 支持
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    # 端口映射
    ports:
      - "8200:8200"
    
    # 环境变量
    environment:
      - MODEL_NAME=deepseek-ai/DeepSeek-OCR
      - OUTPUT_DIR=/app/outputs
      - IDLE_TIMEOUT=3600  # 1 小时空闲超时
      - LAZY_LOAD=true     # 启用按需加载
      - HF_HOME=/root/.cache/huggingface  # Hugging Face 缓存路径
      - MAX_CONCURRENT_REQUESTS=1  # 最大并发请求数（与 PaddleOCR/FunASR/HeyGen 共享 GPU）
      - MAX_FILE_SIZE=20971520     # 最大文件大小 20MB
    
    # 数据卷挂载
    volumes:
      - ./outputs:/app/outputs
      - ./models:/root/.cache/huggingface  # 缓存模型文件
      - ./api_server.py:/app/api_server.py  # 挂载 API 服务文件
    
    # 重启策略
    restart: unless-stopped
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

